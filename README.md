# AUChat (прототип мессенджера)

## Автор
Андрей Усиков, группа 5130904/30102

## Проблема

Пользователям, которым нужно быстро организовать общее текстовое общение **без отвлекающих факторов** в закрытой группе, приходится использовать неподходящие инструменты вроде email-рассылок или социальных сетей, где сообщения теряются в общем потоке и отсутствует структурированный ход беседы. Существующие мессенджеры требуют установки дополнительных приложений и предоставления личных данных, что не всегда приемлемо для рабочих или учебных задач, более того, содержат отвлекающие факторы, что препятствует непрерывному ведению диалога. Это приводит к разрозненности обсуждений, сложностям в отслеживании истории переписки и нарушению контекста общения.

## Выработка требований - пользовательские сценарии

### 1. Регистрация нового пользователя
**Когда** я - новый пользователь, **я хочу** зарегистрироваться в чате с уникальным логином и паролем, **чтобы** получить доступ к общему чату и начать общение с сообществом.

### 2. Вход в систему  
**Когда** я уже зарегистрированный пользователь, **я хочу** войти в систему с помощью своего логина и пароля, **чтобы** продолжить общение в чате и видеть историю сообщений.

### 3. Общение в реальном времени
**Когда** я нахожусь в чате, **я хочу** видеть новые сообщения других пользователей автоматически и отправлять свои, **чтобы** вести плавный и непрерывный разговор.

### 4. Отслеживание активности
**Когда** я общаюсь в чате, **я хочу** видеть кто сейчас онлайн и общую статистику, **чтобы** понимать активность сообщества и чувствовать присутствие других участников.

### 5. Безопасный выход
**Когда** я заканчиваю общение, **я хочу** безопасно выйти из системы, **чтобы** защитить свою учетную запись при использовании на общественных устройствах.

## Архитектура проекта

### Нагрузка на сервис
Учитывая, что мы берем 10000 пользователей в сутки, по опыту общения в чатах на такое число человек можно оценить число одновременно активных пользователей сверху 500 людьми. В таком случае, мы имеем следующие показатели:

#### Соотношение R/W нагрузки
Основную нагрузку на чтение составляет получение истории сообщений, причем этот запрос отправляется от каждого пользователя достаточно часто. Основная нагрузка на запись заключается в отправке пользователями сообщений, что прямо пропорционально числу активных пользователей. Учитывая, что история сообщений проверяется в несколько раз чаще, чем отправляются новые сообщения, можно оценить соотношение нагрузок на чтение и запись как 4 к 1. Таким образом, нагрузки распределены так:

- чтение: 80%
- запись: 20%

#### Объемы трафика
Вводные данные и оценки (взяты сверху исходя из структуры базы данных, размера запросов и статики сайта):
- 50к сообщений в день для 10к пользователей в день
- Объем одного сообщения - 0.5 Кб
- Объем статики, возвращаемой сервером - 0.2 Мб
- Объем одного запроса в среднем - 0.2 Кб, ответа - 3 Кб, запросов всего может быть около 500к
- Объем истории сообщений, показываемой пользователю при входе в чат - 10 Кб, пусть каждый пользователь заходит в чат 20 раз в день
- Объем "подгружаемых" сообщений - 3 Кб, в день таких запросов может быть в районе 300-400к, возьмем 300к

Считаем нагрузку:
- 50к сообщений * 0.5 Кб = 25 Кб в день
- 500к запросов * 0.2 Кб = 100 Мб в день
- 10к пользователей * 0.2 Мб статики = 2 Гб в день
- 200к запросов истории сообщений * 10 Кб = 2 Гб в день
- 300к ответов от сервера * 3 Кб = 900 Мб в день

Итого получаем:
- Входящий трафик на сервис: 125 Мб в день
- Исходящий трафик от сервиса: 4.9 Гб в день
- Суммарно порядка 5 Гб в день


Стоит отметить, что оценки трафика, как и последующие оценки дисковой системы, являются примерными данными, для более реальных данных надо пользоваться бенчмарками трафика, а для более реальных данных дисковой системы - просто использовать сервис какое-то время и посмотреть, сколько дисковой системы занято.

#### Объемы дисковой системы
Оценки памяти для хранения 1 объекта структур (также сверху):
- Сообщения - 0.5 Кб
- Пользователя - 0.2 Кб
- Токенов авторизации - 0.2 Кб

Пускай ежедневно в чате появляются 300 новых пользователей (при той же нагрузке в 10к человек в день), тогда ежедневно требуется 60 Кб на новых пользователей. <br>
Итак, суммарно памяти в день:
- Сообщения - 25 Мб
- Пользователи - 60 Кб
- Сессии - 3 Мб

Таким образом, за год "накапает" порядка 10 Гб. Периодически можно "чистить" неактивных пользователей - например, тех, кто не заходил в учетную запись больше года - тогда объем дисковой системы будет периодически несколько снижаться.

### Диаграмма на уровне контекста
![Context Diagram](/images/c4_1.png)

### Диаграмма на уровне контейнеров
![Container Diagram](/images/c4_2.png)

### Контракты

Все API-контракты находятся [здесь](https://cgsgau3.github.io/AUChat-contracts/). <br>
Ожидаемое время отклика:
- Для запросов авторизации, регистрации - не более 5 секунд
- Для запросов отправки сообщения и получения новых сообщений - не более 5 секунд
- Для загрузки статистики и старых сообщений - не более 3 секунд

### Схема базы данных
![Database Schema](/images/db.png) <br>
База данных должна выдержать нефункциональные требования, потому что основная нагрузка на сервис приходится на чтение, а SQLite слаба в операциях записи, на которые нефункциональные требования несколько мягче.

### Схема масштабирования сервиса

#### Вертикальная
Улучшать "железо", используемое сервером - использовать большую вычислительную мощность и большой объем оперативной памяти. Недостаток состоит в дороговизне оборудования и невозможности улучшать бесконечно.

#### Горизонтальная
Будет заключаться в запуске нескольких серверов одновременно (при едином сервисе базы данных), и интеграция в сервис балансировщика нагрузки (здесь подойдет стратегия Round Robin - если число пользователей возрастет в 10 раз, достаточно запустить сервер на 10 разных машинах для возврата к прежней нагрузке).

#### Изменение принципов работы сервиса
- переход от простого SQLite к более сложному, но более эффективному PostgreSQL, тогда можно улучшить нефункциональные требования на время отклика
- отказ от REST API для функций чата и переход на более эффективные WebSocket-ы, которые, к тому же, позволят получать сообщения в реальном времени, а не с интервалом
- добавление системы потоков для лучшего распараллеливания запросов

## Unit-тестирование
TODO

## Интеграционное тестирование
TODO

## Сборка
TODO
